name: üöÄ Deploy Bun + Elysia to VPS

on:
  push:
    branches:
      - main # ‡πÄ‡∏°‡∏∑‡πà‡∏≠ push ‡πÑ‡∏õ branch main ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô deploy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # üëâ ‡πÄ‡∏û‡∏¥‡πà‡∏° VPS IP ‡πÄ‡∏Ç‡πâ‡∏≤ known_hosts ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ SSH ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
      - name: Add VPS to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # üëâ SSH ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏±‡πà‡∏á Pull + Install + ‡∏™‡∏£‡πâ‡∏≤‡∏á .env + PM2 restart
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }} # IP VPS ‡πÄ‡∏ä‡πà‡∏ô 185.84.160.236
          username: ${{ secrets.VPS_USER }} # ‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ö‡∏ô VPS ‡πÄ‡∏ä‡πà‡∏ô xver
          key: ${{ secrets.VPS_SSH_KEY }} # Private Key ‡∏Ç‡∏≠‡∏á SSH (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Secrets)
          port: 22
          timeout: 30s
          command_timeout: 10m
          script: |
            export PATH="/home/xver/.bun/bin:/home/xver/.nvm/versions/node/v22.16.0/bin:$PATH"

            cd /home/xver/eWeb/api_E-resume

            git reset --hard HEAD
            git clean -fd
            git pull origin main

            bun install

            pm2 restart  api_e-resume --update-env || pm2 start bun --interpreter bun --name  api_e-resume -- src/index.ts
            pm2 save
